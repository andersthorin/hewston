# Story 2.2 — List runs API (filters, pagination, ordering)
Story ID: S2.2
Epic ID: E2



Status: Ready

User Story
- As an API consumer (Frontend Runs List),
- I want GET /backtests to return a paginated, filterable list of run summaries,
- So that I can browse and filter the catalog efficiently.

Context
- Builds on Story 2.1 models/adapter skeleton. Implements list path fully.


Dependencies
- Depends on: S2.1 (models + SQLite adapter)
- Blocks: S6.1 (Runs List UI)

References
- API Contracts: docs/api/openapi.yaml
- Catalog: docs/api/catalog.md
- Source Tree: docs/architecture/source-tree.md
- Error Codes: docs/api/error-codes.md

Definition of Ready
- Context clarified; dependencies and references listed
- ACs measurable and testable; cite canonical docs
- QA mapping present (see docs/qa/story-to-qa-mapping.md)

Acceptance Criteria
1) GET /backtests returns 200 with shape `{ items: RunSummary[], total, limit, offset }`
2) Supports filters: `symbol`, `from`, `to`, `strategy_id`
3) Supports `limit` (1..500), `offset` (>=0), `order` (default `-created_at`), where order may be `created_at` or `-created_at`
4) Items contain: `run_id, created_at, strategy_id, status, symbol, from, to, duration_ms`
5) Performs a single efficient SQL query for items (JOIN or view) plus one COUNT query for total
6) Input validation: invalid order defaults to `-created_at`; invalid limits clamp to bounds
7) Lint passes; handler non-blocking; logs include query params (info level)

Dev Notes (sourced from architecture docs)
- API Contracts: GET /backtests filters and response shape [Source: architecture.md#api-contracts-rest--websocket]
- Catalog Schema: `runs`, `datasets`, and `runs_list` view to expose symbol/from/to [Source: architecture.md#catalog-schema-sqlite-ddl]
- Data Models: RunSummary fields [Source: architecture.md#data-models]
- NFRs: REST latency P50 ≤ 50 ms / P95 ≤ 200 ms (local) [Source: architecture.md#non-functional-requirements-and-performance-budgets]

Technical Specifications
- SQL: Prefer querying the `runs_list` view for (run_id, created_at, strategy_id, status, symbol, from_date, to_date, duration_ms)
- Filtering logic:
  - `symbol`: WHERE symbol = :symbol
  - `from`: WHERE to_date >= :from (overlap)
  - `to`: WHERE from_date <= :to (overlap)
  - `strategy_id`: WHERE strategy_id = :strategy_id
- Ordering: ORDER BY created_at ASC|DESC (map from `order` param)
- Pagination: LIMIT :limit OFFSET :offset; separate `SELECT COUNT(*)` with same filters
- Mapping: Rename from_date→`from`, to_date→`to` in response

Tasks / Subtasks
- Implement `list_runs(filters, limit, offset)` in adapters/sqlite_catalog.py using runs_list view
- Add parameter sanitation in services/backtests.list (limit clamp, order parse)
- Update api/routes/backtests.py to parse query params, call service, and return mapped JSON
- Add simple unit test (optional) to verify SQL where-clause building for various filters
- `make lint` on backend/

Testing & Validation
- Fresh DB: GET /backtests → `{ items: [], total: 0, limit, offset }`
- After inserting sample rows (manual SQL or later stories): verify filters/order/pagination correctness

Definition of Done
- Endpoint returns correct, efficient, and validated results under filters; shapes match OpenAPI; code organized per Source Tree.

