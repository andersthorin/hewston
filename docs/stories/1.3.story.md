# Story 1.3 — Backend skeleton: Backtests routes stubs
Story ID: S1.3
Epic ID: E1



Status: Ready for Review

User Story
- As a developer,
- I want stubbed REST routes for POST/GET /backtests and GET /backtests/{id} aligned with OpenAPI,
- So that the API surface is in place for later wiring to the catalog and job runner.

Context
- Stubs only: no DB or jobs. Return canned responses conforming to the API Contracts.

Acceptance Criteria
1) POST /backtests accepts Idempotency-Key header and a valid request body; responds 202 { run_id, status:"QUEUED" } with a generated placeholder run_id
2) Repeating POST with same Idempotency-Key returns 200 { run_id, status:"EXISTS" } (in-memory cache for stub)
3) GET /backtests returns 200 with shape { items: [], total: 0, limit, offset }
4) GET /backtests/{id} returns 404 with error shape { error: { code:"RUN_NOT_FOUND", message:"..." } }
5) Routes mounted under backend/api/routes/backtests.py and included in app/main.py; lint passes for created files

Dev Notes (sourced from architecture docs)
- API endpoints and shapes (BacktestCreateRequest/Response, Run, RunSummary) [Source: architecture.md#api-contracts-rest--websocket]
- Error shape for REST `{ error: { code, message, details? } }` [Source: architecture.md#api-contracts-rest--websocket]
- Idempotency: accept Idempotency-Key; server will later compute input_hash [Source: architecture.md#api-contracts-rest--websocket]
- Non-blocking handlers; enqueue work out of request path (simulated here) [Source: architecture.md#non-functional-requirements-and-performance-budgets]
- Source Tree: api/routes/backtests.py; app/main.py wires routers [Source: architecture.md#source-tree-and-module-boundaries]

Tasks / Subtasks
- Create backend/api/routes/backtests.py with APIRouter
- Implement POST /backtests stub:
  - Parse JSON; validate minimally (strategy_id, params exist)
  - Read Idempotency-Key; keep an in-memory dict to simulate EXISTS behavior
  - Return 202 on first request, 200 on repeat
- Implement GET /backtests stub: return empty list response with pagination fields
- Implement GET /backtests/{id} stub: return 404 with { error: { code:"RUN_NOT_FOUND", message } }
- Mount router in app/main.py under prefix (none for now) and tag (Backtests)
- Run `make lint` on backend directory

Project Structure Notes
- This is scaffold only; Epics 2–4 replace stubs with real CatalogPort and job orchestration

Definition of Done
- All ACs met; shapes conform to OpenAPI; minimal validation and idempotency simulation included; code organized per Source Tree.



Dev Agent Record
- Agent Model Used: dev (James)

Tasks / Subtasks Checkboxes
- [x] Create backend/api/routes/backtests.py with APIRouter (augment existing)
- [x] Implement POST /backtests stub with Idempotency-Key cache and validation
- [x] Implement GET /backtests stub with empty list and pagination fields
- [x] Implement GET /backtests/{id} stub returning 404 error shape
- [x] Mount router in app/main.py
- [x] Add tests for idempotency, list shape, and 404 error

File List
- Modified: backend/api/routes/backtests.py (REST stubs added)
- Added: tests/backend/test_backtests_rest.py

Completion Notes
- Pytest: 7 passed
- Verified idempotency behavior (202 → 200 same run_id)
- List defaults (limit=20, offset=0) and error shape validated

Debug Log References
- make test → 7 passed

Change Log
- 2025-09-23: Added REST stubs for backtests and tests; marked S1.3 Ready for Review
