# Story 7.2 — Retention and pruning of runs/artifacts
Story ID: S7.2
Epic ID: E7



Status: Ready for Review

User Story
- As an operator,
- I want a retention tool/command that prunes old runs and their artifacts safely,
- So that local storage remains within budget without corrupting the catalog.

Context
- Local-first MVP needs simple retention with dry-run support.


Dependencies
- Depends on: S4.2 (artifacts written), S2.x (catalog present)
- Blocks: N/A

References
- Catalog: docs/api/catalog.md
- Coding Standards: docs/architecture/coding-standards.md
- Source Tree: docs/architecture/source-tree.md

Definition of Ready
- Context clarified; dependencies and references listed
- ACs measurable and testable; cite canonical docs
- QA mapping present (see docs/qa/story-to-qa-mapping.md)

Acceptance Criteria
1) CLI command `retention` (Typer) supports dry-run and apply modes
2) Policy configurable via flags/env (e.g., `--keep-latest 100` or `--max-age 180d`); default keep latest N=100
3) Dry-run prints which run_ids would be removed and total space reclaimed
4) Apply removes artifact directories under `data/backtests/{run_id}/` and updates/removes catalog rows consistently
5) Safety: refuses to run without explicit `--apply` when deletions would occur; logs summary
6) Lint passes; handles interruption gracefully; no partial corruption

Dev Notes (sourced from architecture docs)
- Storage budgets and retention policy [Source: architecture.md#non-functional-requirements-and-performance-budgets]
- Catalog schema (runs + run_metrics) [Source: architecture.md#catalog-schema-sqlite-ddl]
- Operability notes [Source: architecture.md#operability--observability]

Technical Specifications
- Implement `backend/jobs/retention.py` and expose in `backend/jobs/cli.py`
- Selection: order runs by created_at DESC; keep N newest; candidates = remainder (or older than max-age)
- Deletion: remove artifact dirs/files; then delete run_metrics and runs rows for affected run_ids
- Dry-run: compute sizes without deleting; print JSON summary
- Errors: if FS delete fails, log and skip row delete; print remediation hint

Tasks / Subtasks
- Implement retention selection and size computation
- Implement dry-run summary and `--apply` deletion with safeguards
- Integrate with CatalogPort for row deletion
- Add logging summaries (counts, bytes)
- Run `make lint`; verify on sample data

Testing & Validation
- Create sample runs with temp artifacts; dry-run shows expected deletions and sizes
- Apply mode removes files/rows; re-running shows no further deletions

Definition of Done
- Retention tool safely prunes according to policy with dry-run and clear logs; catalog remains consistent.



Dev Agent Record
- Agent Model Used: dev (James)

Tasks / Subtasks Checkboxes
- [x] Implement retention selection and size computation
- [x] Implement dry-run summary and apply deletions with safeguards
- [x] Integrate Typer command into backend/jobs/cli.py
- [x] Add unit test seeding runs and artifacts; validate behavior

File List
- Added: backend/jobs/retention.py
- Modified: backend/jobs/cli.py (retention command)
- Added: tests/backend/test_retention.py

Completion Notes
- Pytest: 19 passed
- Retention tool safe-by-default (requires --apply), prints JSON summaries, deletes run_metrics then runs

Change Log
- 2025-09-23: Implemented S7.2, marked Ready for Review


QA Results
- Gate: PASS
- Summary: Retention tool implements dry-run/apply, candidate selection, size computation, and DB consistency (run_metrics then runs) with tests.
- Evidence: tests/backend/test_retention.py; make test → 19 passed.
- Notes: Tool is safe-by-default (requires --apply). Suggest adding a small cap on deletions per run to prevent accidental mass deletions.
