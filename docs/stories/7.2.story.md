# Story 7.2 â€” Retention and pruning of runs/artifacts
Story ID: S7.2
Epic ID: E7



Status: Draft

User Story
- As an operator,
- I want a retention tool/command that prunes old runs and their artifacts safely,
- So that local storage remains within budget without corrupting the catalog.

Context
- Local-first MVP needs simple retention with dry-run support.

Acceptance Criteria
1) CLI command `retention` (Typer) supports dry-run and apply modes
2) Policy configurable via flags/env (e.g., `--keep-latest 100` or `--max-age 180d`); default keep latest N=100
3) Dry-run prints which run_ids would be removed and total space reclaimed
4) Apply removes artifact directories under `data/backtests/{run_id}/` and updates/removes catalog rows consistently
5) Safety: refuses to run without explicit `--apply` when deletions would occur; logs summary
6) Lint passes; handles interruption gracefully; no partial corruption

Dev Notes (sourced from architecture docs)
- Storage budgets and retention policy [Source: architecture.md#non-functional-requirements-and-performance-budgets]
- Catalog schema (runs + run_metrics) [Source: architecture.md#catalog-schema-sqlite-ddl]
- Operability notes [Source: architecture.md#operability--observability]

Technical Specifications
- Implement `backend/jobs/retention.py` and expose in `backend/jobs/cli.py`
- Selection: order runs by created_at DESC; keep N newest; candidates = remainder (or older than max-age)
- Deletion: remove artifact dirs/files; then delete run_metrics and runs rows for affected run_ids
- Dry-run: compute sizes without deleting; print JSON summary
- Errors: if FS delete fails, log and skip row delete; print remediation hint

Tasks / Subtasks
- Implement retention selection and size computation
- Implement dry-run summary and `--apply` deletion with safeguards
- Integrate with CatalogPort for row deletion
- Add logging summaries (counts, bytes)
- Run `make lint`; verify on sample data

Testing & Validation
- Create sample runs with temp artifacts; dry-run shows expected deletions and sizes
- Apply mode removes files/rows; re-running shows no further deletions

Definition of Done
- Retention tool safely prunes according to policy with dry-run and clear logs; catalog remains consistent.

