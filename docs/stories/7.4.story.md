# Story 7.4 — Error handling and catalog status transitions
Story ID: S7.4
Epic ID: E7



Status: Ready

User Story
- As an API client/operator,
- I want clear error handling and accurate status transitions recorded in the catalog,
- So that failures are visible, diagnosable, and do not leave the system in an inconsistent state.

Context
- Ensure runs move through QUEUED→RUNNING→DONE/ERROR with proper logging and 404/4xx responses.


Dependencies
- Depends on: S4.2 (run job), S4.3 (POST create), S5.x (streaming)
- Blocks: N/A

References
- API Error Codes: docs/api/error-codes.md
- WS Protocol: docs/api/ws-protocol.md
- Source Tree: docs/architecture/source-tree.md
- Coding Standards: docs/architecture/coding-standards.md

Definition of Ready
- Context clarified; dependencies and references listed
- ACs measurable and testable; cite canonical docs
- QA mapping present (see docs/qa/story-to-qa-mapping.md)

Acceptance Criteria
1) When a job fails (e.g., adapter raises), catalog sets status=ERROR and records error code/message in logs
2) GET /backtests/{id} reflects latest status; no partial/incorrect fields returned
3) POST /backtests validation errors return 4xx with `{ error: { code, message, details? } }` shape
4) SSE/WS send `{ "t":"err", code, msg }` on control/stream errors without crashing server; stream ends with `{ "t":"end" }` or closes gracefully
5) Background failures do not block API responsiveness; no event loop blocking introduced
6) Lint passes; added tests (optional) or manual steps documented

Dev Notes (sourced from architecture docs)
- API error shape; WS error events; status transitions [Source: architecture.md#api-contracts-rest--websocket]
- Operability logging fields [Source: architecture.md#operability--observability]
- Catalog schema fields for status and metrics [Source: architecture.md#catalog-schema-sqlite-ddl]

Technical Specifications
- Services/backtests: try/except around subprocess launch and quick validation; return 4xx on bad inputs
- Jobs/run_backtest.py: try/except around adapter; set RUNNING→ERROR on exception; include duration_ms
- Streamer/WS/SSE: validate control payloads; send errs; ensure cleanup on disconnect

Tasks / Subtasks
- Add validation and structured errors to POST handler and services
- Add failure handling in run job: set status ERROR; log with run_id and error code/message
- Add WS/SSE error event sending and graceful termination
- Verify GET endpoints reflect updated status

Testing & Validation
- Simulate adapter failure: confirm status ERROR and logs
- Send invalid POST body: confirm 4xx error shape
- Send bad WS control: confirm `{ "t":"err" }` and stream stability

Definition of Done
- Failures are logged with context; catalog transitions are correct; clients receive standardized errors; system remains responsive.
