# Story 3.1 — Databento ingestion CLI (DBN TRADES+TBBO)
Story ID: S3.1
Epic ID: E3



Status: Draft

User Story
- As a data engineer,
- I want a Typer CLI to ingest Databento DBN for TRADES and TBBO for a symbol-year,
- So that raw inputs are cached locally for deterministic downstream derivation.

Context
- First half of `make data`. Focus on fetching/caching DBN files; no derivation yet.

Acceptance Criteria
1) `make data SYMBOL=AAPL YEAR=2023` invokes backend.jobs.cli `data` which triggers ingestion
2) Raw DBN files are saved under repo-relative paths, e.g., `data/raw/databento/{SYMBOL}/{YEAR}/TRADES.dbn.zst` and `.../TBBO.dbn.zst`
3) Logs show symbol, year, product type(s), byte sizes, and elapsed time
4) Idempotent behavior: re-running for same symbol-year does not re-download if files exist and size > 0 (unless `--force` provided)
5) Uses DATABENTO_API_KEY from environment; fails fast with clear error if missing
6) Lint passes; no blocking of API handlers (CLI only)

Dev Notes (sourced from architecture docs)
- Market Data: Databento SDK (DBN TRADES+TBBO) [Source: architecture.md#tech-stack]
- Data flow: Ingest → cache raw DBN [Source: architecture.md#high-level-overview]
- Determinism: record input file hashes later in manifest (next stories) [Source: architecture.md#determinism--reproducibility-details]
- Source Tree & Jobs: jobs/cli.py, jobs/ingest.py [Source: architecture.md#source-tree-and-module-boundaries]

Technical Specifications
- CLI: Typer command `data` with args `--symbol`, `--year`, flags `--force/--no-force`
- Products: fetch TRADES and TBBO; allow `--products` override later (default both)
- Paths: create directories if missing; write atomically (tmp file -> move)
- Logging: simple stdout logs with sizes and durations (structured logging later)

Tasks / Subtasks
- Implement `backend/jobs/cli.py` Typer app and `data` command stub
- Implement `backend/jobs/ingest.py` function to pull DBN via Databento SDK and write files
- Wire Makefile `make data` to call the Typer command (already prepared)
- Validate env var presence; return non-zero exit on missing key
- `make lint` for backend

Testing & Validation
- With a placeholder/mock or limited real call, verify files created and sizes logged
- Re-run to confirm idempotent skip unless `--force`

Definition of Done
- DBN files fetched and cached with idempotent behavior; logs include sizes and timings; code organized per Source Tree.

