# Story 8.1: BFF Service Infrastructure Setup

**Epic**: Epic 8 — Backend-for-Frontend (BFF) Implementation
**Priority**: High  
**Effort**: 2-3 days  
**Dependencies**: None  
**Status**: Ready for Development

## User Story

As a **developer**,  
I want **a foundational BFF service with health endpoints and proper infrastructure integration**,  
So that **I can build BFF functionality on a solid foundation that integrates seamlessly with the existing Hewston platform**.

## Story Context

### Existing System Integration

- **Integrates with**: Existing monorepo structure (`backend/`, `frontend/`)
- **Technology**: FastAPI + Python 3.11, Docker, existing logging patterns
- **Follows pattern**: Existing backend service structure and FastAPI application factory pattern
- **Touch points**: Docker compose, logging infrastructure, health check patterns

### Business Context

This story establishes the foundational infrastructure for the BFF layer that will eventually reduce frontend complexity and improve API performance. The infrastructure must integrate seamlessly with existing development workflows to ensure team productivity.

## Acceptance Criteria

### Functional Requirements

1. **BFF Service Startup**
   - BFF service starts successfully using FastAPI application factory pattern
   - Service runs on dedicated port (8001) without conflicting with existing services
   - Application follows existing backend structure with `app/main.py` entry point

2. **Health Endpoint**
   - Health endpoint available at `/health` returns 200 status
   - Response includes service name, version, status, and timestamp
   - Health check validates service dependencies (database connectivity)

3. **Docker Integration**
   - BFF service integrates with existing docker-compose.yml
   - Service builds successfully with dedicated Dockerfile
   - Development environment supports hot reload for BFF service

4. **Logging Infrastructure**
   - Structured logging follows existing backend patterns with structlog
   - Log entries include correlation IDs for request tracing
   - Log level configuration matches existing backend service

### Integration Requirements

5. **Existing Services Preserved**
   - Backend and frontend services continue to work unchanged
   - No interference with existing service ports or configurations
   - Development workflow remains identical for existing services

6. **Pattern Consistency**
   - BFF service follows existing FastAPI application structure pattern
   - Directory structure mirrors existing backend organization
   - Configuration management follows existing patterns

7. **Development Workflow**
   - Integration with Docker compose maintains current development workflow
   - Make commands work for BFF service (start, stop, logs, test)
   - Service discovery works correctly in development environment

### Quality Requirements

8. **Testing Foundation**
   - Basic health check tests verify service startup
   - Test framework setup follows existing pytest patterns
   - Test fixtures available for BFF service testing

9. **Documentation**
   - README.md created for BFF service with setup instructions
   - Docker configuration documented with service description
   - Development workflow updated to include BFF service

10. **Regression Prevention**
    - No regression in existing service startup times
    - No conflicts with existing service functionality
    - Development environment stability maintained

## Technical Notes

### Integration Approach
- Create new `bff/` directory in monorepo following existing `backend/` structure
- Use httpx async client for future backend communication
- Implement FastAPI application factory pattern consistent with existing backend

### Existing Pattern Reference
- Mirror `backend/app/main.py` FastAPI application factory pattern
- Follow existing `backend/app/config.py` configuration management
- Use existing Docker patterns from `backend/Dockerfile`

### Key Constraints
- Must not interfere with existing backend/frontend services
- Maintain existing development workflow and port assignments
- Follow established Python/FastAPI conventions from existing backend

### File Structure
```
bff/
├── app/
│   ├── __init__.py
│   ├── main.py              # FastAPI application factory
│   ├── config.py            # Configuration management
│   └── dependencies.py      # Dependency injection
├── api/
│   ├── __init__.py
│   └── health.py            # Health check endpoint
├── tests/
│   ├── __init__.py
│   ├── conftest.py          # Test configuration
│   └── test_health.py       # Health endpoint tests
├── requirements.txt         # BFF dependencies
├── Dockerfile              # BFF containerization
└── README.md               # Service documentation
```

## Definition of Done

- [ ] **Service Startup**: BFF service starts successfully in development environment
- [ ] **Health Endpoint**: `/health` endpoint returns proper status information with service metadata
- [ ] **Docker Integration**: Service builds and runs correctly with existing docker-compose setup
- [ ] **Logging**: Structured logging works with correlation IDs and proper log levels
- [ ] **Testing**: Basic tests pass for service startup and health check functionality
- [ ] **Documentation**: README and setup instructions created for BFF service
- [ ] **Regression**: Existing backend and frontend services continue to function without changes
- [ ] **Development Workflow**: Make commands and development processes work for BFF service

## Risk Assessment

### Primary Risk
**Service Conflicts**: New BFF service interferes with existing backend/frontend services

### Mitigation
- Use dedicated port (8001) for BFF service
- Isolate BFF service in separate Docker container
- Comprehensive testing of service interactions

### Rollback Plan
- Remove BFF service from docker-compose.yml
- Delete bff/ directory
- Existing services continue unchanged

## Testing Strategy

### Unit Tests
- Health endpoint returns correct response format
- Service startup and shutdown work correctly
- Configuration loading follows expected patterns

### Integration Tests
- BFF service starts alongside existing services
- No port conflicts or service interference
- Docker compose works with all services

### Manual Testing
- Verify development workflow with BFF service
- Confirm logging output follows existing patterns
- Test service discovery and health checks

---

**Story ID**: S8.1
**Created**: 2025-01-27
**Epic Reference**: [`docs/prd/epic-8-bff-implementation.md`](../prd/epic-8-bff-implementation.md)
**Architecture Reference**: [`docs/architecture/bff-architecture.md`](../architecture/bff-architecture.md)
