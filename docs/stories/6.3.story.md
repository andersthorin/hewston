# Story 6.3 — WS hook, Worker parsing, and overlays wiring
Story ID: S6.3
Epic ID: E6



Status: Ready for Review

User Story
- As a frontend engineer,
- I want a reusable WebSocket hook with SSE fallback and a Web Worker that parses StreamFrame payloads,
- So that playback parsing is off the main thread and UI remains responsive while updating charts/overlays.

Context
- Infrastructure and wiring to support 6.2 view. Ensures parsing/validation/backpressure handling.


Dependencies
- Depends on: S5.1 (streamer service), S5.2 (WS endpoint), S5.3 (SSE fallback)
- Blocks: S6.2 (Run Detail playback UI)

References
- UX Spec: docs/front-end-spec.md
- Component Map: docs/frontend/component-map.md
- WS Protocol: docs/api/ws-protocol.md
- Schemas: docs/api/schemas/run-manifest.schema.json (context)

Definition of Ready
- UX assets linked (component map)
- ACs measurable and testable; cite canonical docs
- QA mapping present (see docs/qa/story-to-qa-mapping.md)

Acceptance Criteria
1) Implement services/ws.ts `useRunPlayback(runId)` hook that:
   - Connects to WS /backtests/{id}/ws; handles hb/end/err; exposes controls (play/pause/seek/speed)
   - On failure, falls back to SSE /backtests/{id}/stream?speed=60 (read-only)
   - Exposes a stream of frames via callback or observable; includes dropped counter
2) Implement workers/streamParser.ts that:
   - Receives raw WS/SSE messages; validates with Zod `StreamFrame` schema; normalizes to typed objects
   - Batches/coalesces updates to ~30 FPS using requestAnimationFrame-style ticks (postMessage)
3) Backpressure: drop-oldest behavior on internal queue overflow; surface dropped count
4) Type-safe: Zod schemas for StreamFrame and control messages; narrow types in hook API
5) No React components in this story; it’s services/worker only; lint passes

Dev Notes (sourced from architecture docs)
- StreamFrame schema and WS protocol [Source: architecture.md#playback-channel-protocol-websocket]
- Presentational UI principle; data/work off main thread [Source: architecture.md#source-tree-and-module-boundaries]
- NFRs: ~30 FPS; decimation/backpressure [Source: architecture.md#non-functional-requirements-and-performance-budgets]

Technical Specifications
- Files/paths:
  - frontend/src/services/ws.ts — `useRunPlayback(runId)` returning { status, playing, speed, dropped, onPlay, onPause, onSeek, onSpeedChange, subscribe(callback) }
  - frontend/src/workers/streamParser.ts — message types: { type:"init"|"frame"|"hb"|"end"|"err" }, post back normalized frames
  - Optional: frontend/src/services/sse.ts for fallback
  - frontend/src/schemas/stream.ts — Zod schemas for StreamFrame and ctrl
- Hook behavior:
  - Owns socket lifecycle; tries WS first; on error, switches to SSE
  - Provides unsubscribe for frame stream; cleans up on unmount

Tasks / Subtasks
- Define Zod schemas for StreamFrame and ctrl payloads in schemas/stream.ts
- Implement streamParser Worker: parse/validate batch frames; coalesce to ~30 FPS; postMessage to main thread
- Implement useRunPlayback hook: WS connect, ctrl senders, fallback to SSE, subscription API
- Ensure dropped counter exposed; handle hb/end/err gracefully
- ESLint/Prettier; type-check

Testing & Validation
- With a sample run, integrate hook+worker in a sandbox component; verify steady ~30 FPS updates and control handling
- Simulate WS error to verify SSE fallback

Definition of Done
- Hook and Worker provide a robust, type-safe frame pipeline with WS primary and SSE fallback, suitable for Run Detail view integration.


Dev Agent Record
- Agent Model Used: dev (James)

Tasks / Subtasks Checkboxes
- [x] Define Zod schemas for StreamFrame and ctrl in frontend/src/schemas/stream.ts
- [x] Implement worker frontend/src/workers/streamParser.ts for parsing, coalescing, backpressure
- [x] Implement hook frontend/src/services/ws.ts with WS primary and SSE fallback

File List
- Added: frontend/src/schemas/stream.ts
- Added: frontend/src/workers/streamParser.ts
- Added: frontend/src/services/ws.ts

Completion Notes
- Hook and Worker compile within Vite project; integrated minimally (not wired into components per story scope)
- Backpressure handled via drop-oldest queue with cumulative dropped counter

Change Log
- 2025-09-23: Implemented S6.3 and marked Ready for Review
