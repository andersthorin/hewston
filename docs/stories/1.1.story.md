# Story 1.1 — Backend skeleton: health endpoint and app wiring
Story ID: S1.1
Epic ID: E1



Status: Draft

User Story
- As a developer,
- I want a minimal FastAPI app with /healthz and a WS echo endpoint wired per our source tree,
- So that I can validate the runtime, transport, and structure before building catalog, jobs, and playback.

Context
- This story establishes the base app and wiring only; no business logic.


Dependencies
- Depends on: None
- Blocks: S1.2 (WS echo), S1.3 (routes stubs)

References
- WS Protocol: docs/api/ws-protocol.md
- Error Codes: docs/api/error-codes.md
- Baselines: docs/prd/features/00-baselines.md


Definition of Ready
- Context clarified; dependencies and references listed
- ACs measurable and testable; cite canonical docs (baselines, protocol, error codes)
- QA mapping present (see docs/qa/story-to-qa-mapping.md)

Acceptance Criteria
1) `make start-backend` serves GET /healthz → 200 {"status":"ok"}
2) WS at /backtests/{id}/ws upgrades and echoes client `{ "t":"ctrl", ... }` messages
3) API routes live under backend/api/routes; app factory under backend/app/main.py
4) No CPU-bound work in handlers; lint passes for created files

Dev Notes (sourced from architecture docs)
- Tech Stack: FastAPI 0.115.x, Python 3.11.9; WebSocket primary + SSE fallback [Source: architecture.md#tech-stack]
- API Contracts: /healthz; /backtests; /backtests/{id}/ws; /backtests/{id}/stream [Source: architecture.md#api-contracts-rest--websocket]
- Source Tree: app/main.py; api/routes/backtests.py; services/streamer.py; ports/adapters placeholders [Source: architecture.md#source-tree-and-module-boundaries]
- NFRs: API handlers non-blocking; WS jitter targets; no CPU-bound work in request path [Source: architecture.md#non-functional-requirements-and-performance-budgets]

Tasks / Subtasks
- Scaffold backend tree: backend/app/main.py; backend/api/routes/backtests.py; backend/api/routes/health.py
- Implement /healthz returning {"status":"ok"}
- Implement WS echo at /backtests/{id}/ws: accept, parse `{t:ctrl}` messages; echo back
- Wire routers to app; bind to 127.0.0.1 per Security defaults
- Add minimal tests (optional) and run `make lint`

Project Structure Notes
- Ensure created files match documented paths; keep adapters/services as placeholders only.

Definition of Done
- All ACs met; code organized per Source Tree; echo works; no blocking logic in handlers.

