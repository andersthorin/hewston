# Story 5.3 â€” SSE fallback endpoint (frames)
Story ID: S5.3
Epic ID: E5



Status: Ready

User Story
- As a client without WS support,
- I want an SSE endpoint that emits frame events compatible with the StreamFrame schema,
- So that I can still receive time-compressed playback.

Context
- Complements WS endpoint from 5.2. Server-side producer from 5.1 is reused. One-way only; controls via REST (optional later) or query params.


Dependencies
- Depends on: S5.1 (streamer service)
- Blocks: S6.2 (Run Detail playback UI)

References
- WS Protocol: docs/api/ws-protocol.md
- Performance Plan: docs/qa/performance-test-plan.md
- Source Tree: docs/architecture/source-tree.md

Definition of Ready
- Context clarified; dependencies and references listed
- ACs measurable and testable; cite canonical docs
- QA mapping present (see docs/qa/story-to-qa-mapping.md)

Acceptance Criteria
1) GET `/backtests/{id}/stream?speed=60` responds `text/event-stream` and emits `event: frame` with StreamFrame JSON payloads until end
2) Heartbeat supported (either periodic comment lines `:hb` or lightweight `{ "t":"hb" }` events) to keep connections alive
3) Backpressure handled by server decimation; no buffering growth; stability under slower clients
4) Non-blocking; correct headers (Cache-Control: no-cache, Connection: keep-alive)
5) Logs include run_id and counts of frames sent

Dev Notes (sourced from architecture docs)
- SSE fallback path and StreamFrame shape [Source: architecture.md#playback-channel-protocol-websocket]
- NFRs: ~30 FPS target; backpressure via decimation [Source: architecture.md#non-functional-requirements-and-performance-budgets]
- API Contracts include SSE endpoint [Source: architecture.md#api-contracts-rest--websocket]

Technical Specifications
- Implement adapters/streams.py SSE handler using `services/streamer` async generator
- Write each frame as `event: frame` + `data: {json}` + `\n\n`; flush after each write
- Include simple heartbeat (comment lines) at ~15s
- Controls: keep simple for MVP (speed via query param); advanced controls can remain WS-only

Tasks / Subtasks
- Add GET `/backtests/{id}/stream` to adapters/streams.py
- Map `speed` query param to initial streamer speed; ignore ctrl thereafter
- Ensure proper headers and streaming flush; run `make lint`

Testing & Validation
- Curl or browser test: `curl -N http://127.0.0.1:8000/backtests/{id}/stream?speed=60` and observe `event: frame` lines
- Simulate slow consumer; verify stability and no unbounded memory

Definition of Done
- SSE endpoint reliably streams frames compatible with StreamFrame schema, with basic heartbeat and decimation; no blocking.
