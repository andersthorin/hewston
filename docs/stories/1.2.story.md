# Story 1.2 — Backend skeleton: WebSocket echo endpoint
Story ID: S1.2
Epic ID: E1



Status: Ready for Review

User Story
- As a developer,
- I want a WebSocket endpoint at /backtests/{id}/ws that accepts connections and echoes control messages,
- So that we can validate the transport, message shapes, and non-blocking server behavior before implementing streaming.

Context
- This story focuses on wiring the WS endpoint and basic message handling (ctrl + hb). No frame production yet.


Dependencies
- Depends on: S1.1 (backend skeleton)
- Blocks: S5.1 (streamer service + frame decimation)

References
- WS Protocol: docs/api/ws-protocol.md
- Error Codes: docs/api/error-codes.md
- Baselines: docs/prd/features/00-baselines.md


Definition of Ready
- Context clarified; dependencies and references listed
- ACs measurable and testable; cite canonical docs (baselines, protocol, error codes)
- QA mapping present (see docs/qa/story-to-qa-mapping.md)

Acceptance Criteria
1) Client connects to ws://localhost:8000/backtests/{id}/ws and receives periodic `{ "t":"hb" }` from server (5s)
2) When client sends `{ "t":"ctrl", "cmd":"play|pause|seek|speed", ... }`, server echoes the same payload back with an added field `{ "echo": true }`
3) Server handles invalid payloads by returning `{ "t":"err", "code":"VALIDATION", "msg":"..." }` (and does not crash)
4) Implementation is non-blocking (no CPU-bound work). Lint passes for created files
5) Endpoint location and wiring match the Source Tree & API Contracts

Dev Notes (sourced from architecture docs)
- WS Protocol & control messages (ctrl/frame/end/err/hb), heartbeat every 5s; decimation policy deferred [Source: architecture.md#playback-channel-protocol-websocket]
- API Contracts specify GET /backtests/{id}/ws and error shape `{ error: { code, message, details? } }` for REST; for WS we use `{ t:"err", code, msg }` [Source: architecture.md#api-contracts-rest--websocket]
- Non-blocking handlers; heavy work outside request path [Source: architecture.md#non-functional-requirements-and-performance-budgets]
- Security default: bind to 127.0.0.1; no auth [Source: architecture.md#operability--observability]
- Source Tree: app/main.py wires WS; adapters/streams.py later for real streaming [Source: architecture.md#source-tree-and-module-boundaries]

Tasks / Subtasks
- Declare WS route at /backtests/{id}/ws in backend/app/main.py (or routed module), matching path in OpenAPI
- Implement handler that:
  - Accepts connection; starts heartbeat task sending `{ "t":"hb" }` every 5s
  - Awaits client messages; if `{t:"ctrl"}` then echo payload + `{echo:true}`; else send `{t:"err", code:"VALIDATION"}`
  - Cleans up on disconnect; logs connect/disconnect with run_id
- Ensure no CPU-bound logic; keep echo minimal. Add basic validation of `cmd` field set
- Run `make lint` to ensure style passes for added files

Project Structure Notes
- Put WS handler in app/main.py for now; in later epics, move streaming logic to services/streamer.py and adapters/streams.py per architecture

Definition of Done
- All ACs met; echo behavior verified manually with a WS client; code lives in documented locations and is non-blocking.



Dev Agent Record
- Agent Model Used: dev (James)

Tasks / Subtasks Checkboxes
- [x] Declare WS route /backtests/{id}/ws in routed module
- [x] Start heartbeat task sending {"t":"hb"} every 5s
- [x] Echo {t:"ctrl"} payloads with {echo:true}
- [x] Validate ctrl.cmd (play|pause|seek|speed); send {t:"err", code:"VALIDATION"} on invalid
- [x] Handle invalid JSON and unsupported messages with {t:"err"}
- [x] Cleanup on disconnect; non-blocking design
- [x] Tests for hb/err/echo behaviors

File List
- Modified: backend/api/routes/backtests.py (heartbeat + validation)
- Added: tests/backend/test_ws_behavior.py
- Modified: tests/backend/test_ws_echo.py (graceful close)

Completion Notes
- Pytest: 4 passed
- Verified hb event via monkeypatched interval
- Echo/validation behaviors exercised via tests

Debug Log References
- make test → 4 passed


QA Results
- Gate: PASS
- Summary: WebSocket echo endpoint and basic validation implemented; tests cover echo and invalid messages.
- Evidence: tests/backend/test_ws_echo.py, tests/backend/test_ws_behavior.py.
- Notes: None.
