# Story 8.6: Frontend Migration and Feature Flags

**Epic**: Epic 8 â€” Backend-for-Frontend (BFF) Implementation
**Priority**: High
**Effort**: 3-4 days
**Dependencies**: Stories 8.3, 8.4, 8.5 (Chart Data, Run Data, WebSocket Proxy)
**Status**: Ready for Development

## User Story

As a **developer**,  
I want **to safely migrate frontend API calls to BFF endpoints with rollback capability**,  
So that **I can reduce frontend complexity while maintaining the ability to quickly revert if issues arise**.

## Story Context

### Existing System Integration

- **Integrates with**: Frontend API client (`frontend/src/services/api.ts`), React components, TypeScript types
- **Technology**: React + TypeScript, Zod validation, TanStack Query, feature flag system
- **Follows pattern**: Existing frontend API patterns and error handling
- **Touch points**: Chart components, run detail views, WebSocket hooks, API utilities

### Business Context

This story completes the BFF implementation by migrating frontend code to use the new aggregated endpoints while maintaining safety through feature flags. This enables the team to realize the benefits of reduced complexity while having confidence in rollback capabilities.

## Acceptance Criteria

### Functional Requirements

1. **API Client Migration**
   - Update `frontend/src/services/api.ts` to use BFF endpoints as primary
   - Implement feature flags to control BFF vs direct backend usage
   - Maintain existing API client interface for component compatibility
   - Support gradual migration of individual endpoint groups

2. **Feature Flag Implementation**
   - Environment-based feature flags for BFF endpoint usage
   - Runtime toggle capability for immediate rollback
   - Granular flags for different endpoint groups (chart data, run data, WebSocket)
   - Feature flag status visible in development tools

3. **Type System Updates**
   - Update TypeScript types to match new BFF response formats
   - Maintain backward compatibility during migration period
   - Generate types from BFF API schemas where possible
   - Zod schema updates for new response validation

4. **Component Simplification**
   - Remove complex data transformation logic from chart components
   - Simplify run detail components to use aggregated data
   - Update WebSocket connection management to use BFF proxy
   - Eliminate multiple loading states where BFF provides aggregation

### Integration Requirements

5. **Backward Compatibility**
   - Existing components continue to work during migration
   - Feature flags allow selective rollback of individual features
   - No breaking changes to component interfaces
   - Existing error handling patterns preserved

6. **Performance Validation**
   - Chart loading performance meets or exceeds current performance
   - Run detail loading shows improvement from aggregated endpoints
   - WebSocket streaming maintains existing performance characteristics
   - No regression in user experience metrics

7. **Error Handling Migration**
   - Update error handling to work with BFF error formats
   - Maintain existing user-facing error messages
   - Add BFF-specific error context for debugging
   - Preserve error correlation across service boundaries

### Quality Requirements

8. **Testing Coverage**
   - Update existing component tests to work with BFF responses
   - Add feature flag testing for both enabled and disabled states
   - Integration tests verify BFF endpoint usage
   - Regression tests ensure no functionality loss

9. **Monitoring Integration**
   - Frontend performance monitoring for BFF endpoint usage
   - Error tracking and reporting for BFF-related issues
   - Feature flag usage analytics and performance comparison
   - User experience metrics before and after migration

10. **Documentation Updates**
    - Update frontend development documentation for BFF usage
    - Feature flag documentation and rollback procedures
    - API client usage examples with new endpoints
    - Troubleshooting guide for BFF-related issues

## Technical Notes

### Feature Flag Implementation
```typescript
// Feature flag configuration
interface BFFFeatureFlags {
  useChartDataAggregation: boolean;
  useRunDataAggregation: boolean;
  useWebSocketProxy: boolean;
  enableBFFErrorHandling: boolean;
}

// API client with feature flag support
class APIClient {
  async getChartData(params: ChartDataParams): Promise<ChartData> {
    if (featureFlags.useChartDataAggregation) {
      return this.bffClient.getChartData(params);
    }
    return this.legacyClient.getChartData(params);
  }
}
```

### Type System Migration
```typescript
// New BFF response types
interface BFFChartDataResponse {
  symbol: string;
  timeframe: string;
  bars: BarData[];
  metadata: {
    total_bars: number;
    decimated: boolean;
    cache_hit: boolean;
    load_time_ms: number;
  };
}

// Backward compatible type unions during migration
type ChartDataResponse = BFFChartDataResponse | LegacyChartDataResponse;
```

### Component Simplification Example
```typescript
// Before: Complex data coordination
const RunDetailView = ({ runId }: Props) => {
  const { data: run, loading: runLoading } = useQuery(['run', runId]);
  const { data: metrics, loading: metricsLoading } = useQuery(['metrics', runId]);
  const { data: equity, loading: equityLoading } = useQuery(['equity', runId]);
  
  if (runLoading || metricsLoading || equityLoading) return <Loading />;
  // Complex coordination logic...
};

// After: Single aggregated request
const RunDetailView = ({ runId }: Props) => {
  const { data: completeRun, loading } = useQuery(['run-complete', runId]);
  
  if (loading) return <Loading />;
  // Simple rendering with aggregated data...
};
```

### Migration Strategy
1. **Phase 1**: Implement feature flags and BFF client integration
2. **Phase 2**: Migrate chart data endpoints with A/B testing
3. **Phase 3**: Migrate run data endpoints and validate performance
4. **Phase 4**: Migrate WebSocket connections and remove legacy code

## Definition of Done

- [ ] **API Client Migration**: Frontend API client successfully uses BFF endpoints with feature flag control
- [ ] **Feature Flags**: Granular feature flags enable selective BFF usage and rollback capability
- [ ] **Type System**: TypeScript types updated for BFF responses with backward compatibility
- [ ] **Component Simplification**: Frontend components simplified to use aggregated BFF data
- [ ] **Performance Validation**: BFF migration shows performance improvement or maintains current levels
- [ ] **Testing**: Comprehensive tests cover both BFF and legacy modes with feature flag scenarios
- [ ] **Documentation**: Frontend development documentation updated for BFF usage patterns
- [ ] **Monitoring**: Performance and error monitoring validates successful migration

## Risk Assessment

### Primary Risk
**Frontend Regression**: Migration introduces bugs or performance issues in frontend

### Mitigation
- Comprehensive feature flag testing in both modes
- Gradual migration with performance monitoring
- Immediate rollback capability through feature flags

### Secondary Risk
**Type System Complexity**: Managing dual type systems during migration increases complexity

### Mitigation
- Clear migration timeline to minimize dual-system period
- Comprehensive TypeScript testing
- Documentation of type migration patterns

### Rollback Plan
- Feature flags provide immediate rollback to direct backend calls
- Component interfaces remain compatible with legacy API responses
- Monitoring alerts trigger automatic rollback if performance degrades

## Testing Strategy

### Unit Tests
- Feature flag logic and API client routing
- Component behavior with both BFF and legacy responses
- Type system compatibility and validation
- Error handling for both API modes

### Integration Tests
- End-to-end frontend flows with BFF endpoints
- Feature flag toggling and rollback scenarios
- Performance comparison between BFF and legacy modes
- Error handling and user experience validation

### A/B Testing
- Performance comparison between BFF and direct backend usage
- User experience metrics for chart loading and run analysis
- Error rate monitoring for both API modes
- Feature flag usage analytics

### Regression Tests
- Existing frontend functionality preserved
- No performance degradation in critical user flows
- Error handling maintains existing user experience
- WebSocket streaming performance maintained

### Performance Tests
- Chart loading time comparison
- Run detail loading performance validation
- WebSocket streaming latency measurement
- Memory usage and resource utilization

---

**Story ID**: S8.6
**Created**: 2025-01-27
**Epic Reference**: [`docs/prd/epic-8-bff-implementation.md`](../prd/epic-8-bff-implementation.md)
**Architecture Reference**: [`docs/architecture/bff-architecture.md`](../architecture/bff-architecture.md)
