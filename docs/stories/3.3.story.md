# Story 3.3 — Upsert Dataset in Catalog (SQLite) with Manifest
Story ID: S3.3
Epic ID: E3



Status: Draft

User Story
- As a platform engineer,
- I want to upsert a Dataset row (and bars manifest path) into the SQLite catalog after derivation,
- So that datasets are discoverable and re-usable by backtest creation and listing.

Context
- Completes the `make data` flow by persisting catalog metadata for the derived slice.

Acceptance Criteria
1) After `make data SYMBOL=AAPL YEAR=2023`, a `datasets` row exists with:
   - dataset_id (stable slug/UUID), symbol, from_date, to_date, products_json ["TRADES","TBBO"], calendar_version, tz
   - raw_dbn_json and bars_parquet_json lists populated; bars_manifest_path set
   - generated_at (UTC), size_bytes (sum of files), status='READY'
2) Upsert behavior: if the same dataset_id exists, update paths/sizes/status deterministically
3) dataset_id is returned by `MarketDataPort.ensure_dataset(...)` for use in later stories
4) Idempotency: re-running `make data` does not create duplicate dataset rows
5) Lint passes; adapter/service layering respected

Dev Notes (sourced from architecture docs)
- Catalog Schema (SQLite DDL): datasets table fields and indexes [Source: architecture.md#catalog-schema-sqlite-ddl]
- Data Models: Dataset and DatasetManifest [Source: architecture.md#data-models]
- Source Tree/Ports: MarketDataPort.ensure_dataset; CatalogPort.upsert_dataset/get_dataset [Source: architecture.md#source-tree-and-module-boundaries]
- Determinism: stable dataset_id; SHA-256 hashes referenced in manifest [Source: architecture.md#determinism--reproducibility-details]

Technical Specifications
- Compute dataset_id as stable slug: `{SYMBOL}-{YEAR}-1m` (or UUID if collision scenarios later); document choice in manifest
- Build upsert payload from Story 3.1/3.2 outputs; ensure JSON TEXT fields serialize with sorted keys
- Use `adapters/sqlite_catalog.py` to implement `upsert_dataset(dataset: dict)` and `get_dataset(dataset_id)`
- Return dataset_id from `MarketDataPort.ensure_dataset(symbol, from_date, to_date)` (implemented in adapters/databento.py)

Tasks / Subtasks
- Implement CatalogPort.upsert_dataset/get_dataset methods in sqlite adapter
- Implement MarketDataPort.ensure_dataset to drive ingest→derive→upsert and return dataset_id
- Update jobs/cli.py `data` command to print the resulting dataset_id
- Verify row content via sqlite3; add basic logging of fields and sizes
- `make lint` for backend

Testing & Validation
- Run `make data SYMBOL=AAPL YEAR=2023`; query sqlite for row; verify fields and READY status
- Re-run; verify upsert (no duplicate rows), stable dataset_id

Definition of Done
- Catalog reflects the derived dataset with accurate metadata and manifest reference; ensure_dataset returns dataset_id; flow is idempotent.
